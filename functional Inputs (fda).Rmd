---
title: "functional Inputs"
author: "Rohan Mishra"
date: "7/6/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = FALSE)
library(fda)
library(tidyverse)
library(gridExtra)
source("/mnt/fda_CI.R")

```

For our meeting with 7/15/22, we want to show the following:
  - Regression models with Tc as an input for regression along with Tin
  - We also want to show via specific coloring of the input, we can show a level of prediction on Tc and Tin
    - with this level of Tc and Tin, we can predict the concentration to be in this range


In last week's meeting, we showed a function on function regression. We predicted output C_a as a function of Tin. 


```{r load data and create list}


### load the data
data <- "/mnt/DATA/Tin & Tc Variation/fiveRunsallCombosDiffInsNoNoise.csv" %>% read_csv() 
#data <- "/mnt/DATA/Tin & Tc Variation/fiveRunsallCombosDiffIns.csv" %>% read_csv() 

#datatemp <- data %>% filter(time %in% c(1:50))

## split the data
data_sp <- data %>% 
  split(f=data$Replicate) 
rep <- names(data_sp)


meanTc_Tin <- lapply(data_sp, function(i) {
  i %>% 
    summarise(Tin_group = round(mean(Temp_inlet)) %>% as.character(),Tc_group = round(mean(coolingTemp)) %>% as.character())
  }) %>% 
  bind_rows() %>%
 mutate(Replicate = rep)
# meanTc_Tin$Replicate <- as.integer(meanTc_Tin$Replicate)


data2 <- inner_join(data,meanTc_Tin, by = "Replicate")
#data2$factor <- paste(data2$Replicate, data2$meanTin,data2$meanTc, sep = "_")


#### PLOTS FOR SLIDE #3 #####
meanTc_conA_5_sec <- data2 %>% 
  filter(time <5) %>% 
  #filter()
  ggplot(aes(x=time, y = concentrationA, color = Tc_group, group = as.character(Replicate))) + 
  geom_line() + ggtitle("Output of Ca over First 5 seconds by Mean Tc")
  
meanTc_temp_5sec <-  data2 %>% 
  filter(time <5) %>%
  ggplot(aes(x=time, y = Temp, color = Tc_group, group = as.character(Replicate))) + 
  geom_line() + ggtitle("Output of Reactor Temperature over First 5 seconds by Mean Tc")

#grid.arrange(meanTc_conA_5_sec, meanTc_temp_5sec)  
######


#### PLOTS FOR SLIDE #4 #####
only_275Tc <- data2 %>% 
  filter(time < 2) %>%  
  filter(Tc_group == 275) %>%
  ggplot(aes(x=time, y=concentrationA, color = Tin_group, group = Replicate)) + 
  geom_line() +
  ggtitle("Concentration of A for Tc = 275K")

only_275_Tc <- data2 %>% 
  filter(time < 2) %>%  
  filter(Tc_group == 275) %>%
  ggplot(aes(x=time, y=Temp, color = Tin_group, group = Replicate)) + 
  geom_line() +
  ggtitle("Reactor Temperature for Tc = 275K")

#grid.arrange(only_275Tc, only_275_Tc)
#######
```


```{r fda}

### output concentrationA temperature
data_con <- lapply(data_sp, function(i)
  i %>%
    select(time, concentrationA)) %>%
  reduce(inner_join, by = "time")
names(data_con) <- c("time", rep)
ts.plot(data_con[,-1], gpars = list(main = "C_a Raw Plot"))

### inlet temperature
data_Tin <- lapply(data_sp, function(i)
  i %>%
    select(time, Temp_inlet)) %>%
  reduce(inner_join, by = "time")
names(data_Tin) <- c("time", rep)
ts.plot(data_Tin[,-1], gpars = list(main = "Tin Raw Plot"))

### reactor temperature
data_temp <- lapply(data_sp, function(i)
  i %>%
    select(time, Temp)) %>%
  reduce(inner_join, by = "time")
names(data_temp) <- c("time", rep)
ts.plot(data_temp[,-1], gpars = list(main = "Reactor Temp Plot"))

data_Tc <- lapply(data_sp, function(i)
  i %>%
    select(time, coolingTemp)) %>%
  reduce(inner_join, by = "time")
names(data_Tc) <- c("time", rep)
ts.plot(data_Tc[,-1], gpars = list(main = "Cooling Temp Plot"))



basis <- create.bspline.basis(rangeval = c(0,5001), nbasis = 50)
#basis_small <- create.bspline.basis(rangeval = c(0,21), nbasis = 10)

data_con_fd <- smooth.basis(argvals = 1:5001,data_con[,-1] %>% as.matrix(),basis)$fd
data_Tin_fd <- smooth.basis(argvals = 1:5001,data_Tin[,-1] %>% as.matrix(),basis)$fd
data_Tc_fd <- smooth.basis(argvals = 1:5001,data_Tc[,-1] %>% as.matrix(),basis)$fd

data_temp_fd <- smooth.basis(argvals = 1:5001,data_temp[,-1] %>% as.matrix(),basis)$fd

Tin_sca <- apply(data_Tin[,-1],2,unique) %>% unlist()
Tc_sca <- apply(data_Tc[,-1],2,unique) %>% unlist()

colTin <- colnames(data_Tin[,-1])
Tin_sca <- as.numeric(str_split_fixed(colTin, fixed("_"), 3)[,1])

colTc <- colnames(data_Tc[,-1])
Tc_sca <- as.numeric(str_split_fixed(colTc, fixed("_"), 3)[,2])


f_func_all <- fRegress(data_con_fd ~ data_Tin_fd + data_Tc_fd)
f_func_sca <- fRegress(data_con_fd ~ Tin_sca + Tc_sca)

f_temp <- fRegress(data_temp_fd ~ data_Tin_fd + data_Tc_fd)

f = f_func_all
par(mfrow=c(3,2))
ts.plot(data_con[,-1], gpars = list(main = "Reactor Temp Raw Plot")); grid()
ts.plot(data_Tin[,-1], gpars = list(main = "Tin Raw Plot")); grid()
#plot(data_con_fd)
plot(f$yhatfdobj); title("Y_hat Plots (con ~ Tin + Tc)"); grid()
plot(f$betaestlist$const); title("Beta0"); grid()
plot(f$betaestlist$data_Tin_fd); title("Beta1 (Tin)"); grid()
plot(f$betaestlist$data_Tc_fd); title("Beta2 (Tc)"); grid()

# f = f_func_all
# par(mfrow=c(2,1))
# ts.plot(data_con[,-1], gpars = list(main = "Concentration A Raw Plot")); grid()
# ts.plot(data_Tin[,-1], gpars = list(main = "Tin Raw Plot")); grid()
# #plot(data_con_fd)
# plot(f$yhatfdobj); title("Y_hat Plots (con ~ Tin + Tc)"); grid()
# plot(f$betaestlist$const); title("Beta0"); grid()
# plot(f$betaestlist$data_Tin_fd); title("Beta1 (Tin)"); grid()
# plot(f$betaestlist$data_Tc_fd); title("Beta2 (Tc)"); grid()


```


```{r find out of control outputs}

par(mfrow=c(3,2))
for(i in 2:46){
  ts.plot(data_temp[,i])
}

par(mfrow=c(3,2))
ts.plot(data_con[,19], gpars = list(main = "Tin = 351; Tc = 306", ylab = "Con A"))
ts.plot(data_temp[,19], gpars=list(main =  "Tin = 351; Tc = 306", ylab = "Reactor Temp"))
ts.plot(data_con[,22], gpars = list(main = "Tin = 353; Tc = 303", ylab = "Con A"))
ts.plot(data_temp[,22], gpars=list(main = "Tin = 353; Tc = 303", ylab = "Reactor Temp"))
ts.plot(data_con[,33], gpars = list(main = "Tin = 356; Tc = 301", ylab = "Con A",  cex.lab = 5))
ts.plot(data_temp[,33], gpars=list(main = "Tin = 356; Tc = 301", ylab = "Reactor Temp"))


8+(-0.010)*(0)+(-0.0105)*(0)

8+(-0.010)*(350)+(-0.0105)*(275)



```

```{r plotting by color, echo = FALSE}

#r1=readRDS("/mnt/CODE/fRegress_results_func_and_scalar.rds")
r1 <- f_func_sca
r1$betalist$const$fd$fdnames %>% names()



pred.y= r1$yhatfdobj$y
colnames(pred.y)

ts.plot(pred.y)
colnames(pred.y)
u.Tin_sca =unique(Tin_sca)
u.Tin_sca
u.Tin_sca.l= length(u.Tin_sca)

palette(rainbow(u.Tin_sca.l))
palette()



mycolor=
ifelse ( Tin_sca == 345, 1, 
         ifelse (  Tin_sca == 346, 1, 
                  ifelse ( Tin_sca == 348, 1,
                           ifelse ( Tin_sca == 350, 4,
                                    ifelse ( Tin_sca == 351, 4,
                                             ifelse ( Tin_sca == 353, 4,
                                                      ifelse (Tin_sca == 355,7,
                                                              ifelse (Tin_sca == 356,7,
                                                                      ifelse (Tin_sca == 358,7,
                                                                              ifelse (Tin_sca == 360,10,
                                                                                      ifelse (Tin_sca == 361,10,
                                                                                              ifelse (Tin_sca == 365,10,NA
                                                      ))))))) ) ) ) ) )




plot(0:5001,pred.y[,1],type="l",col="red", lwd=3 , ylim=c(0,1.3), lty=2)
i=2
for (i in 2:dim(pred.y)[2]){
  print(paste("i=",i,mycolor[i],sep=","))
  
  lines(0:500,pred.y[,i], col=mycolor[i], lwd=3, lty=2)
}
plot(pred.y)



```



```{r establish Tc & Tin groupings for Ca, echo = FALSE}

groupings <- data.frame(
  Tin_group = str_split_fixed(colTc,"_",3)[,1] %>% as.numeric() %>% plyr::round_any( 5, f = floor),
  Tc_group = str_split_fixed(colTc,"_",3)[,2] %>% as.numeric() %>% plyr::round_any( 5, f = floor),
  Tin = str_split_fixed(colTc,"_",3)[,1] %>% as.numeric(),
  Tc = str_split_fixed(colTc,"_",3)[,2] %>% as.numeric()
)




f_df <- data.frame(f_func_all$yhatfdobj$fd$coefs)
f_df <- data.frame(eval.fd(1:5001, f_func_all$yhatfdobj$fd))
#f_df <- data.frame(eval.fd(1:5001, f_temp$yhatfdobj$fd))
colnames(f_df) <- colTc

f_df_long <-  f_df %>%
  mutate(Time = seq(0,500, by = 0.1)) %>%
  pivot_longer(`345_250_1`:`365_310_5`, names_to = "Inputs", values_to = "Concentration") %>%
  mutate(Tin = as.numeric(str_split_fixed(Inputs, "_",3)[,1]),
         Tc = as.numeric(str_split_fixed(Inputs,"_",3 )[,2])) %>%
  inner_join(groupings, by = c("Tin","Tc"))
  


(f_Tin_plot <- f_df_long %>%
  filter(Tin_group %in% c(345,355,360)) %>%
  ggplot(aes(x=Time, y=Concentration,color=as.factor(Tin_group), group = Inputs)) + 
    geom_line() +
    ggtitle("Concentration Grouped by Tin Group") + ylim(0,1.5)
  )

(f_Tc_plot <- f_df_long %>%
  filter(Tc_group %in% c(250,275,300)) %>%
  ggplot(aes(x=Time, y=Concentration,color=as.factor(Tc_group), group = Inputs)) + 
    geom_line()+
    ggtitle("Concentration Grouped by Tc Group") + ylim(0,1.5)
  )

grid.arrange(f_Tin_plot, f_Tc_plot)

```


```{r color plots by Tin group for Ca}

Tins <- unique(f_df_long$Tin_group)

f_df_lists <- as.list(rep(NA,length(unique(f_df_long$Tin_group))))
for(i in 1:length(Tins)) {
  
  f_df_lists[[i]] <- f_df_long %>%
    filter(Tin_group == Tins[i]) %>%
    select(Time:Concentration) #%>%
    #pivot_wider(names_from = "Inputs", values_from = "Concentration") 
    
}
names(f_df_lists) <- as.character(Tins)

f_df_lists <- lapply(f_df_lists, function(i){
  i %>%
    pivot_wider(names_from = "Inputs", values_from = "Concentration") %>%
    select(!Time) 
})

f_avg_ca <- lapply(f_df_lists, function(i){
  rowMeans(i)
}) %>% 
  as.data.frame() %>%
  mutate(Time = seq(0,500,by=0.1)) %>% 
  pivot_longer(`X345`:`X365`, names_to = "Tin_group", values_to = "Mean_Ca") %>%
  mutate(Tin_group = str_remove(Tin_group,"X"))

f_Tin_mean_plot <- f_avg_ca %>%
  ggplot(aes(x=Time, y=Mean_Ca,color=as.factor(Tin_group), group=Tin_group)) + 
  geom_line() + 
  ggtitle("Mean Concentration by Inlet Temperature") + ylim(0,1.5)



```


```{r color plots by Tc group for Ca}

Tcs <- unique(f_df_long$Tc_group)

f_df_lists_2 <- as.list(rep(NA,length(unique(f_df_long$Tc_group))))
for(i in 1:length(Tcs)) {
  
  f_df_lists_2[[i]] <- f_df_long %>%
    filter(Tc_group == Tcs[i]) %>%
    select(Time:Concentration) #%>%
    #pivot_wider(names_from = "Inputs", values_from = "Concentration") 
    
}
names(f_df_lists_2) <- as.character(Tcs)

f_df_lists_2 <- lapply(f_df_lists_2, function(i){
  i %>%
    pivot_wider(names_from = "Inputs", values_from = "Concentration") %>%
    select(!Time) 
})

f_avg_ca_2 <- lapply(f_df_lists_2, function(i){
  rowMeans(i)
}) %>% 
  as.data.frame() %>%
  mutate(Time = seq(0,500,by=0.1)) %>% 
  pivot_longer(`X250`:`X310`, names_to = "Tc_group", values_to = "Mean_Ca") %>%
  mutate(Tc_group = str_remove(Tc_group,"X"))
colnames(f_avg_ca_2)


f_Tc_mean_plot <- f_avg_ca_2 %>%
  ggplot(aes(x=Time, y=Mean_Ca,color=as.factor(Tc_group), group=Tc_group)) + 
  geom_line() + ggtitle("Mean Concentration by Cooling Temperature") + ylim(0,1.5)

grid.arrange(f_Tin_mean_plot, f_Tc_mean_plot)

```


```{r establish Tc & Tin groupings for temp, echo = FALSE}

groupings <- data.frame(
  Tin_group = str_split_fixed(colTc,"_",3)[,1] %>% as.numeric() %>% plyr::round_any( 5, f = floor),
  Tc_group = str_split_fixed(colTc,"_",3)[,2] %>% as.numeric() %>% plyr::round_any( 5, f = floor),
  Tin = str_split_fixed(colTc,"_",3)[,1] %>% as.numeric(),
  Tc = str_split_fixed(colTc,"_",3)[,2] %>% as.numeric()
)




f_df <- data.frame(f_func_all$yhatfdobj$fd$coefs)
#f_df <- data.frame(eval.fd(1:5001, f_func_all$yhatfdobj$fd))
f_df <- data.frame(eval.fd(1:5001, f_temp$yhatfdobj$fd))
colnames(f_df) <- colTc

f_df_long <-  f_df %>%
  mutate(Time = seq(0,500, by = 0.1)) %>%
  pivot_longer(`345_250_1`:`365_310_5`, names_to = "Inputs", values_to = "Reactor_Temperature") %>%
  mutate(Tin = as.numeric(str_split_fixed(Inputs, "_",3)[,1]),
         Tc = as.numeric(str_split_fixed(Inputs,"_",3 )[,2])) %>%
  inner_join(groupings, by = c("Tin","Tc"))
  


(f_Tin_plot <- f_df_long %>%
  #filter(Tin_group = 365) %>%
  ggplot(aes(x=Time, y=Reactor_Temperature,color=as.factor(Tin_group), group = Inputs)) + 
    geom_line() +
    ggtitle("Reactor_Temperature Grouped by Tin Group") #+ ylim(0,1.5)
  )

(f_Tc_plot <- f_df_long %>%
  #filter(Tin_group != 365) %>%
  ggplot(aes(x=Time, y=Reactor_Temperature,color=as.factor(Tc_group), group = Inputs)) + 
    geom_line()+
    ggtitle("Reactor_Temperature Grouped by Tc Group") #+ ylim(0,1.5)
  )

grid.arrange(f_Tin_plot, f_Tc_plot)

```


```{r color plots by Tin group for temp}

Tins <- unique(f_df_long$Tin_group)

f_df_lists <- as.list(rep(NA,length(unique(f_df_long$Tin_group))))
for(i in 1:length(Tins)) {
  
  f_df_lists[[i]] <- f_df_long %>%
    filter(Tin_group == Tins[i]) %>%
    select(Time:Reactor_Temperature) #%>%
    #pivot_wider(names_from = "Inputs", values_from = "Reactor_Temperature") 
    
}
names(f_df_lists) <- as.character(Tins)

f_df_lists <- lapply(f_df_lists, function(i){
  i %>%
    pivot_wider(names_from = "Inputs", values_from = "Reactor_Temperature") %>%
    select(!Time) 
})

f_avg_ca <- lapply(f_df_lists, function(i){
  rowMeans(i)
}) %>% 
  as.data.frame() %>%
  mutate(Time = seq(0,500,by=0.1)) %>% 
  pivot_longer(`X345`:`X365`, names_to = "Tin_group", values_to = "Mean_Temp") %>%
  mutate(Tin_group = str_remove(Tin_group,"X"))

f_Tin_mean_plot <- f_avg_ca %>%
  ggplot(aes(x=Time, y=Mean_Temp,color=as.factor(Tin_group), group=Tin_group)) + 
  geom_line() + 
  ggtitle("Mean Reactor_Temperature by Inlet Temperature") #+ ylim(0,1.5)



```


```{r color plots by Tc group for temp}

Tcs <- unique(f_df_long$Tc_group)

f_df_lists_2 <- as.list(rep(NA,length(unique(f_df_long$Tc_group))))
for(i in 1:length(Tcs)) {
  
  f_df_lists_2[[i]] <- f_df_long %>%
    filter(Tc_group == Tcs[i]) %>%
    select(Time:Reactor_Temperature) #%>%
    #pivot_wider(names_from = "Inputs", values_from = "Reactor_Temperature") 
    
}
names(f_df_lists_2) <- as.character(Tcs)

f_df_lists_2 <- lapply(f_df_lists_2, function(i){
  i %>%
    pivot_wider(names_from = "Inputs", values_from = "Reactor_Temperature") %>%
    select(!Time) 
})

f_avg_ca_2 <- lapply(f_df_lists_2, function(i){
  rowMeans(i)
}) %>% 
  as.data.frame() %>%
  mutate(Time = seq(0,500,by=0.1)) %>% 
  pivot_longer(`X250`:`X310`, names_to = "Tc_group", values_to = "Mean_Temp") %>%
  mutate(Tc_group = str_remove(Tc_group,"X"))
colnames(f_avg_ca_2)


f_Tc_mean_plot <- f_avg_ca_2 %>%
  ggplot(aes(x=Time, y=Mean_Temp,color=as.factor(Tc_group), group=Tc_group)) + 
  geom_line() + ggtitle("Mean Reactor_Temperature by Cooling Temperature") #+ ylim(0,1.5)

grid.arrange(f_Tin_mean_plot, f_Tc_mean_plot)

```