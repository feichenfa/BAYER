---
title: "Steady State Simulation 2 fRegress"
author: "Rohan Mishra"
date: "06/09/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)
library(fda)
library(tidyverse)
library(deSolve)
source("/mnt/fda_CI.R")

```

## Simulated Data

We simulate two datasets below. The first dataset is our 'categorical' dataset. The second dataset is our 'continuous' dataset.

The first simulated dataset used $Temperature \in \{275, 285\}$. The second simulated dataset focuses on Temperatures around 275.

```{r ODE1, echo=FALSE}

# ODE with collision rate noise added
SIR.noise <- function(time, state, parameters) {
  with(as.list(c(state, parameters)),
       {
         dCdt = -k  * C
         return(list(c(dCdt))) 
       })}


# Arrehenius equation
A = 7.2e10
E = 72751.96
R = 8.31451
T = 400

k.arrhenius = function(A, E, R, T) {A*exp(1)^(-E/(R*T))}


# Generate and plot data
state <- c(C=1) #initial conditions for odes
time <-seq(from = 0, to = 5000, length.out = 5001)


# Noise N(0,1) on temp
result.1 = NULL
for(Temp in c(275, 280, 285)) {
  for(T in round(Temp + rnorm(10, 0, 1), 4)) {
    k = k.arrhenius(A,E,R,T)
    out.test = ode(y=state, 
                   times=time,
                   func=SIR.noise, 
                   parms=c(k = k))
    result.1 = rbind(result.1, cbind(k=k, Temp=Temp, T=T, out.test))
  }
}

result.df = as.data.frame(result.1)
result.df$Temp = as.factor(result.df$Temp)
result.df %>%
  filter(Temp != 280) %>%
  ggplot( aes(x=time, y=C, group=T, color=Temp)) +
    geom_line() +
    ggtitle('Categorical Temperature Dataset') +
   # scale_y_continuous(trans='log10') +
    ylim(c(0,1)) +
    ylab('Concentration') +
    xlab('Time')


# Noise N(0,2) on temp
result.2 = NULL
for(Temp in c(275)) {
  for(T in round(Temp + rnorm(50, 0,1), 4)) {
    k = k.arrhenius(A,E,R,T)
    out.test = ode(y=state, 
                   times=time,
                   func=SIR.noise, 
                   parms=c(k = k))
    result.2 = rbind(result.2, cbind(k=k, Temp=Temp, T=T, out.test))
  }
}

result.df2 = as.data.frame(result.2)
result.df2$Temp = as.factor(result.df2$Temp)
ggplot(result.df2, aes(x=time, y=C, group=T, color=Temp)) +
  geom_line() +
  ggtitle('Continuous Temperature Dataset') +
 # scale_y_continuous(trans='log10') +
  ylim(c(0,1)) +
  ylab('Concentration') +
  xlab('Time')

```



### Functional Regression

With the simulated datasets converted to functional data, we can conduct a functional regression analysis. In this case, we can treat the C curves as the response, and the temperature as a variable. This would be a functional response regressed over a scalar variable. 


```{r fda for fRegress, include=FALSE}

head(result.df)
r_wide <- result.df %>% 
  filter(Temp != 280) %>%
  select(!c(k, Temp)) %>%
  pivot_wider(names_from = T, values_from = C) 

basis <- create.bspline.basis(rangeval = c(0,5001), nbasis = 10)

r_fd <- smooth.basis(r_wide$time, r_wide[,-1] %>% as.matrix(), basis)$fd


r2_wide <- result.df2 %>%
  select(!c(k, Temp)) %>%
  pivot_wider(names_from = T, values_from = C) 

r_fd2 <- smooth.basis(r2_wide$time, r2_wide[,-1] %>% as.matrix(), basis)$fd

#temps <- names(r_wide[,-1])


#temps.cat2 <- c(rep(-1,10),rep(0,10),rep(1,10))
```


### Categorical Regression

Below, we conduct the regression with temperature as a categorical variable, using the first dataset with $Temperature \in \{275, 285\}$. The first plot represents the "constant" curve, when the temperature is 275. The second plot represents the coefficient curve we add if the temperature is 285. The first curve alone represents our response curve if temperature is 275. The first curve and second curve added together represents our response curve if temperature is 285.

```{r cat fRegress, echo = FALSE}

temps.cat <- c(rep("275",10),
               #rep("280",10),
               rep("285",10))

catRegress <- fRegress(r_fd ~ temps.cat)
par(mfrow=c(2,2))
plot.fd(catRegress$betaestlist$const$fd); grid(); title(main="Constant Regression Curve")
#plot.fd(catRegress$betaestlist$temps.cat.280$fd); grid()
plot.fd(catRegress$betaestlist$temps.cat.285$fd); grid(); title(main = "285 Degree Coefficient")
plot(catRegress$yhatfdobj$fd); grid(); title("yhat")



```


### Continuous Regression

Below, we conduct the regression with temperature as a continuous variable, using the second dataset with Temperature around 275 degrees. The first plot represents the "constant" curve. The second plot represents the coefficient curve we multiply by 1 of 50 temperatures in our dataset to get our response C curve.


```{r continuous regression, echo=FALSE}

raw_temps <- names(r2_wide[,-1]) %>% as.numeric()

contRegress <- fRegress(r_fd2 ~ raw_temps)
par(mfrow=c(2,2))
plot.fd(contRegress$betaestlist$const$fd); grid(); title(main = "Constant Coefficient")
plot.fd(contRegress$betaestlist$raw_temps$fd); grid(); title(main="Temperature Variable Coefficient")
plot(contRegress$yhatfdobj$fd); grid(); title("yhat")


```
