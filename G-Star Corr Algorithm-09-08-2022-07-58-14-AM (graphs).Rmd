---
title: "G-Star Corr Algorithm"
author: "Rohan Mishra"
date: "9/7/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

library(HMPTrees)
library(data.table)
library(tidyverse)
library(akima)
options(scipen=9999)


timeSplit4 <- function(data, secs = 7200, rows = 604800) {
  data <- data[1:rows,]
  #data <- data %>% select(sensors)
  data$TimeGroup <- cut(1:dim(data)[1], seq(0, dim(data)[1], secs), labels = FALSE)
  #data$SPO2 <- data$SPO2 + runif(dim(data)[1], -.1, .1)
  data.split <- split(data, f = data$TimeGroup)
  return(data.split)
}


```

```{r Sensor Plots}

par(mfrow=c(3,2))
plot(data$concentrationA, type = "l", main = "Concentration of A");grid();abline(v=seq(0,5000,by=50)); 
plot(data$Temp, type = "l", main = "Reactor Temperature");grid();abline(v=seq(0,5000,by=50))

plot(data$coolingTemp, type = "l", main = "Cooling Temperature");grid();abline(v=seq(0,5000,by=50))
plot(data$Temp_inlet, type = "l", main = "Inlet Temperature");grid();abline(v=seq(0,5000,by=50))
lines(smooth.spline(data$Temp_inlet, spar = 0.2), col = "red", lwd=2)

plot(data$flowRate, type = "l", main = "Flow Rate");grid();abline(v=seq(0,5000,by=50))
lines(smooth.spline(data$flowRate, spar = 0.2), col = "red", lwd = 2)
plot(data$concentrationA_inlet, type = "l", main = "Inlet Concentration of A");grid();abline(v=seq(0,5000,by=50))
lines(smooth.spline(data$concentrationA_inlet, spar = 0.2), col = "red", lwd = 2)



```


```{r Normal Data}

data <- fread("/mnt/DATA/Fei/cstr_functional_ontology_synethic_08242022.csv")


MLE.normal <- data %>% 
  dplyr::filter(Mode == "Normal") %>%
  timeSplit4(secs = 50, rows = 4500) %>%
  lapply(function(i) {
    i %>% 
    dplyr::select(concentrationA_inlet, Temp_inlet, flowRate, concentrationA, Temp)
  }) %>%
  lapply(cor) %>%
  lapply(function(i){
    cordf <- as.data.frame(as.table(i)) 
    combinations = combn( colnames(i) , 2 , FUN = function(x) { paste(x, collapse = "_" )})
    cordf = cordf[ cordf$Var1 != cordf$Var2 , ]
    cordf = cordf[ paste( cordf$Var1 , cordf$Var2 , sep = "_" ) %in% combinations , ]
    cordf$Vars <- paste(cordf$Var1,cordf$Var2, sep = "_:_")
    cordf <- cordf %>% select(Vars, Freq)
  }) %>%
  imap(.x = ., ~ set_names(.x, c("Vars", .y))) %>% 
  reduce(dplyr::inner_join, by = "Vars") %>%
  column_to_rownames(var = "Vars") %>%
  getMLEandLoglike()

round(MLE.normal$mleTree,2)


```


```{r Abnormal Data, echo=FALSE}


MLE.abnormal <- data %>% 
  filter(Mode == "Abnormal") %>%
  timeSplit4(secs = 50, rows = 500) %>%
  lapply(function(i) {
    i %>% 
    dplyr::select(concentrationA_inlet, Temp_inlet, flowRate, concentrationA, Temp)
  }) %>%
  lapply(cor) %>%
  lapply(function(i){
    cordf <- as.data.frame(as.table(i)) 
    combinations = combn( colnames(i) , 2 , FUN = function(x) { paste(x, collapse = "_" )})
    cordf = cordf[ cordf$Var1 != cordf$Var2 , ]
    cordf = cordf[ paste( cordf$Var1 , cordf$Var2 , sep = "_" ) %in% combinations , ]
    cordf$Vars <- paste(cordf$Var1,cordf$Var2, sep = "_:_")
    cordf <- cordf %>% select(Vars, Freq)
  }) %>%
  imap(.x = ., ~ set_names(.x, c("Vars", .y))) %>% 
  reduce(dplyr::inner_join, by = "Vars") %>%
  column_to_rownames(var = "Vars") %>%
  getMLEandLoglike()


round(MLE.abnormal$mleTree,2)


```

```{r All Data}


MLE.all <- data %>%
  timeSplit4(secs = 50, rows = 5000) %>%
  lapply(function(i) {
    i %>% 
    dplyr::select(concentrationA_inlet, Temp_inlet, flowRate, concentrationA, Temp)
  }) %>%
  lapply(cor) %>%
  lapply(function(i){
    cordf <- as.data.frame(as.table(i)) 
    combinations = combn( colnames(i) , 2 , FUN = function(x) { paste(x, collapse = "_" )})
    cordf = cordf[ cordf$Var1 != cordf$Var2 , ]
    cordf = cordf[ paste( cordf$Var1 , cordf$Var2 , sep = "_" ) %in% combinations , ]
    cordf$Vars <- paste(cordf$Var1,cordf$Var2, sep = "_:_")
    cordf <- cordf %>% select(Vars, Freq)
  }) %>%
  imap(.x = ., ~ set_names(.x, c("Vars", .y))) %>% 
  reduce(dplyr::inner_join, by = "Vars") %>%
  column_to_rownames(var = "Vars") %>%
  getMLEandLoglike()

gstar_3 <- round(cbind(MLE.all$mleTree, MLE.normal$mleTree, MLE.abnormal$mleTree),2) %>%
  as.data.frame()## relabel columns!!
colnames(gstar_3) <- c("All", "Normal", "Abnormal")
gstar_3

```



```{r GStar for each group of 10 graphs}

new_cors <- data %>%
  timeSplit4(secs = 50, rows = 5000) %>%
  lapply(function(i) {
    i %>% 
    dplyr::select(concentrationA_inlet, Temp_inlet, flowRate, concentrationA, Temp)
  }) %>%
  lapply(cor) %>%
  lapply(function(i){
    cordf <- as.data.frame(as.table(i)) 
    combinations = combn( colnames(i) , 2 , FUN = function(x) { paste(x, collapse = "_" )})
    cordf = cordf[ cordf$Var1 != cordf$Var2 , ]
    cordf = cordf[ paste( cordf$Var1 , cordf$Var2 , sep = "_" ) %in% combinations , ]
    cordf$Vars <- paste(cordf$Var1,cordf$Var2, sep = "_:_")
    cordf <- cordf %>% select(Vars, Freq)
  }) %>%
  imap(.x = ., ~ set_names(.x, c("Vars", .y))) %>% 
  reduce(dplyr::inner_join, by = "Vars") %>%
  column_to_rownames(var = "Vars")



#check newcors
#dim(new_cors)
MLEs <- list()
for(i in 1:10){
  selCols <- 1:10 + (i-1)*10
  new_cors2 <- new_cors[,selCols]
  m <- getMLEandLoglike(new_cors2)
  MLEs[[i]] <- m
}

MLE_table <- lapply(MLEs, function(i) { 
  i$mleTree %>% rownames_to_column(var="Corr")
  }) %>%
  imap(.x = ., ~ set_names(.x, c("Corr", .y))) %>%
  reduce(dplyr::inner_join, by = "Corr") %>%
  column_to_rownames(var = "Corr")

gstar10 <- as.data.frame(round(MLE_table, 2))
#colnames(gstar10) <- c("")



par(mfrow=c(3,2))
plot(data$concentrationA, type = "l", main = "Concentration of A");grid();abline(v=seq(0,5000,by=500)); 
plot(data$Temp, type = "l", main = "Reactor Temperature");grid();abline(v=seq(0,5000,by=500))

plot(data$coolingTemp, type = "l", main = "Cooling Temperature");grid();abline(v=seq(0,5000,by=500))
plot(data$Temp_inlet, type = "l", main = "Inlet Temperature");grid();abline(v=seq(0,5000,by=500))
lines(smooth.spline(data$Temp_inlet, spar = 0.2), col = "red", lwd=2)

plot(data$flowRate, type = "l", main = "Flow Rate");grid();abline(v=seq(0,5000,by=500))
lines(smooth.spline(data$flowRate, spar = 0.2), col = "red", lwd = 2)
plot(data$concentrationA_inlet, type = "l", main = "Inlet Concentration of A");grid();abline(v=seq(0,5000,by=500))
lines(smooth.spline(data$concentrationA_inlet, spar = 0.2), col = "red", lwd = 2)







```

```{r LRT}

pval <- compareTwoDataSets(new_cors[c(1:80,91:100)] , new_cors[81:90], numPerms = 1000)
pval


```

```{r rpart}

gibbsRpartCV


```





```{r RPart}

test <- rpart(coolingTemp ~ corMatrix) #pseudocode




```
